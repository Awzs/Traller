# 服务测试使用说明

## 概述

本项目提供了一个完整的服务测试脚本，用于验证API更新后的服务功能。测试脚本会连接到已运行的开发服务，执行全面的功能测试。

## 使用步骤

### 1. 启动开发服务

首先，在一个终端窗口中启动开发服务：

```bash
cd backend
pnpm start
```

等待服务启动完成，看到类似以下输出：

```
[Nest] Application successfully started
Application is running on: http://localhost:3000
```

### 2. 运行服务测试

在另一个终端窗口中运行测试脚本：

```bash
cd backend
npm run test:service
```

## 测试内容

测试脚本会自动执行以下测试：

### 🔍 基础连接测试
- 检查服务是否可访问
- 验证健康检查端点

### 📡 API功能测试
1. **查询端点测试**
   - 发送测试查询请求
   - 验证Perplexity和Kimi API集成
   - 检查响应结构和数据完整性
   - 记录响应时间

2. **数据获取测试**
   - 获取单个查询结果
   - 获取所有查询列表
   - 验证数据格式

3. **数据管理测试**
   - 删除测试数据
   - 验证清理功能

## 测试输出示例

```
🔗 正在连接到运行中的服务...
服务地址: http://localhost:3000
⏳ 检查服务连接...
✅ 服务连接成功

=== 测试健康检查 ===
✅ 健康检查通过
响应状态: 200
响应内容: Hello World!

=== 测试查询端点 ===
发送查询请求: { query: '马斯克', queryType: 'people' }
✅ 查询请求成功
响应状态: 201
响应时间: 15234ms
实体数量: 5
查询ID: 507f1f77bcf86cd799439011
✅ 响应结构验证通过

=== 测试获取查询结果 ===
✅ 获取查询结果成功
响应状态: 200
查询ID: 507f1f77bcf86cd799439011
原始查询: 马斯克

=== 测试获取所有查询 ===
✅ 获取所有查询成功
响应状态: 200
查询总数: 1

=== 测试删除查询 ===
✅ 删除查询成功
响应状态: 200
响应内容: { success: true, message: 'Query result deleted successfully' }

📊 测试结果总结
==================
健康检查: ✅ 通过
查询端点: ✅ 通过
获取查询结果: ✅ 通过
获取所有查询: ✅ 通过
删除查询: ✅ 通过
==================
总计: 5/5 测试通过
🎉 所有服务测试通过！服务运行正常。

🧹 测试完成，清理环境...
✅ 测试环境已清理
```

## 故障排除

### 连接失败

如果看到以下错误：

```
❌ 无法连接到服务 http://localhost:3000，请确保服务已启动 (pnpm start)
```

**解决方案：**
1. 确认开发服务已启动
2. 检查端口3000是否被占用
3. 确认服务启动无错误

### API测试失败

如果API测试失败，请检查：

1. **环境变量配置**
   - 确保`.env`文件中配置了正确的API密钥
   - 检查`PERPLEXITY_API_KEY`和`KIMI_API_KEY`

2. **网络连接**
   - 确保网络连接正常
   - 检查防火墙设置

3. **数据库连接**
   - 确保MongoDB服务正常运行
   - 检查数据库连接字符串

### 超时错误

如果遇到超时错误，可能是因为：
- API响应时间较长（正常情况下可能需要10-30秒）
- 网络连接不稳定
- API服务暂时不可用

## 注意事项

1. **测试数据**：测试会创建临时数据，并在测试结束后自动清理
2. **API配额**：测试会消耗API调用配额，请注意使用量
3. **并发测试**：避免同时运行多个测试实例
4. **服务状态**：确保开发服务在测试期间保持运行

## 自定义测试

如需修改测试内容，可以编辑`scripts/test-service.ts`文件：

- 修改测试查询内容
- 调整超时时间
- 添加新的测试用例
- 自定义测试报告格式