# 🚀 高上下文处理优化配置

## 概述

为了支持萃流系统对高上下文和丰富信息的需求，我们对所有AI服务进行了深度优化，大幅提升了处理能力和信息质量。

## 🔧 优化配置详情

### 1. Gemini 2.5 Flash服务优化

#### Token限制提升
- **之前**: MiniMax M1 `max_tokens: 4000`
- **现在**: Gemini 2.5 Flash `max_tokens: 8000` (+100%提升)
- **超时时间**: 从90秒增加到180秒 (+100%提升)
- **模型升级**: 从MiniMax M1升级为Google Gemini 2.5 Flash

#### Prompt深度优化
- **实体数量**: 从最多10个增加到15-20个相关实体
- **关系评分**: 提供详细的5级评分标准(1-2, 3-4, 5-6, 7-8, 9-10分)
- **描述长度**: 从简短描述扩展到800-1500字的深度分析
- **结构化内容**: 使用丰富的Markdown格式(标题、粗体、斜体、引用、列表)
- **分析维度**: 包含15个维度的深度分析要求

### 2. Perplexity服务优化

#### Token限制提升
- **之前**: `max_tokens: 4000`
- **现在**: `max_tokens: 8000` (+100%提升)
- **超时时间**: 从120秒增加到180秒 (+50%提升)

#### 搜索深度优化
- **信息维度**: 从7个基本维度扩展到17个深度维度
- **关系网络**: 新增5大关系类别的详细分析
- **背景调研**: 新增8个深度背景调研方向
- **特别关注**: 新增3个创新和规划维度

### 3. 前端API优化

#### 超时时间调整
- **之前**: `timeout: 120000` (2分钟)
- **现在**: `timeout: 240000` (4分钟)
- **目的**: 为后端复杂处理提供充足时间缓冲

## 📊 优化效果对比

### 处理能力提升

| 指标 | 优化前 | 优化后 | 提升比例 |
|------|--------|--------|----------|
| **Gemini Token限制** | 4,000 | 8,000 | +100% |
| **Perplexity Token限制** | 4,000 | 8,000 | +100% |
| **实体分析数量** | ≤10个 | 15-20个 | +50-100% |
| **描述文字长度** | 简短 | 800-1500字 | +300-500% |
| **信息分析维度** | 7个 | 17个 | +143% |
| **处理超时时间** | 90-120秒 | 180-240秒 | +50-100% |

### 信息质量提升

#### 深度分析能力
- ✅ **关系网络**: 从简单关联到多维度关系网络分析
- ✅ **时间线索**: 增加历史发展轨迹和事件时间线
- ✅ **背景调研**: 从基础信息到深度背景调研
- ✅ **影响力评估**: 新增行业地位和社会影响力分析
- ✅ **未来规划**: 增加战略规划和发展方向分析

#### 结构化程度
- ✅ **Markdown格式**: 丰富的格式化支持(标题、列表、引用等)
- ✅ **引用系统**: 完善的引用标记和来源追踪
- ✅ **分类组织**: 按重要性和时间线组织信息
- ✅ **关系评分**: 精细化的5级关系紧密度评分

## 🎯 使用场景适配

### 适合的查询类型
- 🔍 **复杂人物关系**: 企业家、政治家、学者等有丰富关系网络的人物
- 🏢 **企业生态分析**: 大型企业及其生态系统分析
- 📈 **行业领袖调研**: 需要深度背景分析的重要人物
- 🌐 **社会网络分析**: 需要构建完整关系图谱的查询

### 性能考虑
- ⏱️ **处理时间**: 单次查询可能需要2-4分钟
- 💾 **内容量**: 单个实体描述可达1000-1500字
- 🔗 **引用数量**: 每个实体可能包含10-20个引用链接
- 📊 **数据量**: 总响应数据可能达到几十KB

## 🚨 使用建议

### 1. 查询优化
```bash
# 推荐的查询格式
✅ "马云及其商业帝国"
✅ "Elon Musk和他的创新企业"
✅ "张一鸣的字节跳动生态"

# 避免的查询格式
❌ "马云"  # 过于简单
❌ "某个不知名的人"  # 信息不足
```

### 2. 性能监控
- 📊 监控单次查询处理时间
- 💾 关注内存使用情况
- 🔗 验证API调用成功率
- ⚡ 优化高峰期访问策略

### 3. 错误处理
- 🚨 超时错误: 适当增加前端等待时间
- 📝 Token超限: 优化输入查询长度
- 🔑 API限额: 合理分配调用频率

## 🔧 故障排除

### 常见问题

#### 1. 处理时间过长
```bash
# 检查后端日志
tail -f backend/logs/application.log | grep "Processing time"

# 优化查询
- 缩短查询文本
- 避免过于复杂的查询
```

#### 2. Token超限错误
```bash
# 检查API配置
grep "max_tokens" backend/src/services/*.ts

# 调整Token分配策略
- Perplexity: 重点获取原始信息
- Gemini: 重点结构化处理
```

#### 3. 超时错误
```bash
# 检查超时配置
grep "timeout" backend/src/services/*.ts frontend/src/services/api.ts

# 调整超时时间
- 后端处理: 3分钟
- 前端等待: 4分钟
```

---

## ✅ 验证步骤

### 1. 后端验证
```bash
cd backend
pnpm run data test "马云"
# 期望: 完整的JSON响应，包含15-20个实体
```

### 2. 前端验证
```bash
cd frontend
pnpm run dev
# 访问 http://localhost:5173
# 输入"马云"查询，等待2-4分钟
```

### 3. 性能测试
```bash
# 测试复杂查询
curl -X POST http://localhost:3000/api/query \
  -H "Content-Type: application/json" \
  -d '{"query": "马云及其阿里巴巴生态系统"}'
```

---

**配置优化完成！现在系统支持高上下文、深度分析的复杂查询处理，并具备智能JSON修复能力。** 🎉 