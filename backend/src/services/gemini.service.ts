import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import axios from 'axios';
import { EntityResponseDto } from '../dto/query.dto';
import { JsonRepairService } from './json-repair.service';

interface OpenRouterResponse {
  choices: {
    message: {
      content: string;
    };
  }[];
  usage: {
    prompt_tokens: number;
    completion_tokens: number;
  };
}

@Injectable()
export class GeminiService {
  private readonly logger = new Logger(GeminiService.name);
  private readonly apiKey: string;
  private readonly apiUrl: string;

  constructor(
    private configService: ConfigService,
    private jsonRepairService: JsonRepairService,
  ) {
    // ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™ä½¿ç”¨ç¡¬ç¼–ç å¯†é’¥
    this.apiKey = this.configService.get<string>('KIMI_API_KEY') || '';
    this.apiUrl = this.configService.get<string>('KIMI_API_URL') || '';
  }

  async structureData(
    perplexityResponse: string,
    originalQuery: string,
  ): Promise<EntityResponseDto[]> {
    try {
      const prompt = `ä½œä¸ºä¸“ä¸šçš„å…³ç³»ç½‘ç»œåˆ†æå¸ˆå’Œæ•°æ®ç»“æ„åŒ–ä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹æœç´¢ç»“æœï¼Œæ„å»º"${originalQuery}"çš„å®Œæ•´å…³ç³»ç”Ÿæ€å›¾è°±ã€‚

## ğŸ“Š åŸå§‹æ•°æ®æº
${perplexityResponse}

## ğŸ¯ æ ¸å¿ƒä»»åŠ¡è¦æ±‚

### 1. ä¸»ä½“è¯†åˆ«ä¸å®šä½
- å°†"${originalQuery}"è®¾å®šä¸ºid=0çš„æ ¸å¿ƒä¸»ä½“ï¼ˆä¸»è§’ï¼‰
- æ·±åº¦åˆ†æä¸»ä½“çš„å¤šé‡èº«ä»½ã€æ ¸å¿ƒä»·å€¼å’Œç¤¾ä¼šå®šä½
- æ„å»ºä¸»ä½“çš„å®Œæ•´ç”»åƒå’Œå‘å±•è½¨è¿¹

### 2. å…³ç³»ç½‘ç»œæ„å»º
è¯·è¯†åˆ«å¹¶åˆ†æ**12-15ä¸ªæœ€é‡è¦çš„ç›¸å…³å®ä½“**ï¼ˆäººç‰©/å…¬å¸ï¼‰ï¼Œæ„å»ºå¤šå±‚æ¬¡å…³ç³»ç½‘ç»œï¼š

#### ğŸ”¥ æ ¸å¿ƒåœˆå±‚ï¼ˆ9-10åˆ†ï¼‰
- **å®¶åº­æˆå‘˜**ï¼šé…å¶ã€å­å¥³ã€çˆ¶æ¯ã€å…„å¼Ÿå§å¦¹
- **åˆ›ä¸šä¼™ä¼´**ï¼šè”åˆåˆ›å§‹äººã€æ—©æœŸåˆä¼™äººã€æ ¸å¿ƒè‚¡ä¸œ
- **ç›´æ¥ä¸šåŠ¡å…³ç³»**ï¼šç°ä»»å…¬å¸ã€ç›´æ¥æŠ•èµ„å…³ç³»ã€æ§è‚¡ä¼ä¸š

#### â­ é‡è¦åœˆå±‚ï¼ˆ7-8åˆ†ï¼‰
- **å…³é”®æŠ•èµ„äºº**ï¼šå¤©ä½¿æŠ•èµ„äººã€VCæœºæ„ã€é‡è¦è‚¡ä¸œ
- **æ ¸å¿ƒå›¢é˜Ÿ**ï¼šCTOã€CFOã€æ ¸å¿ƒé«˜ç®¡ã€å·¦å³æ‰‹
- **æˆ˜ç•¥ä¼™ä¼´**ï¼šé‡è¦å®¢æˆ·ã€ä¾›åº”å•†ã€åˆä½œä¼™ä¼´
- **è¡Œä¸šå¯¼å¸ˆ**ï¼šèŒä¸šå¯¼å¸ˆã€ç²¾ç¥å¯¼å¸ˆã€å¼•è·¯äºº

#### ğŸŒŸ å½±å“åœˆå±‚ï¼ˆ5-6åˆ†ï¼‰
- **åŒè¡Œç²¾è‹±**ï¼šè¡Œä¸šç«äº‰å¯¹æ‰‹ã€åŒçº§ä¼ä¸šå®¶
- **ä¸“ä¸šç½‘ç»œ**ï¼šè¡Œä¸šåä¼šã€ä¸“ä¸šç»„ç»‡ã€å’¨è¯¢é¡¾é—®
- **åª’ä½“å…³ç³»**ï¼šé‡è¦åª’ä½“äººã€æ„è§é¢†è¢–ã€å…¬å…³ä¼™ä¼´

#### ğŸ“¡ å¤–å›´åœˆå±‚ï¼ˆ3-4åˆ†ï¼‰
- **ç¤¾äº¤ç½‘ç»œ**ï¼šæœ‹å‹ã€æ ¡å‹ã€ç¤¾äº¤ä¼™ä¼´
- **å…¬ç›Šå…³ç³»**ï¼šæ…ˆå–„ç»„ç»‡ã€å…¬ç›Šä¼™ä¼´ã€ç¤¾ä¼šè´£ä»»
- **æ–‡åŒ–å…³ç³»**ï¼šæ–‡åŒ–ç•Œæœ‹å‹ã€è‰ºæœ¯æ”¶è—ã€å…´è¶£åœˆ

### 3. å…³ç³»ç´§å¯†åº¦è¯„åˆ†æ ‡å‡†
**10åˆ†**ï¼šè¡€ç¼˜å…³ç³»ã€é…å¶å…³ç³»ã€è”åˆåˆ›å§‹äºº
**9åˆ†**ï¼šæ ¸å¿ƒå®¶åº­æˆå‘˜ã€åˆ›ä¸šæ ¸å¿ƒå›¢é˜Ÿã€æ§è‚¡å…³ç³»
**8åˆ†**ï¼šé‡è¦æŠ•èµ„äººã€æ ¸å¿ƒé«˜ç®¡ã€æˆ˜ç•¥åˆä½œä¼™ä¼´
**7åˆ†**ï¼šé‡è¦å‘˜å·¥ã€è‘£äº‹ä¼šæˆå‘˜ã€é•¿æœŸåˆä½œä¼™ä¼´
**6åˆ†**ï¼šè¡Œä¸šåˆä½œä¼™ä¼´ã€é‡è¦å®¢æˆ·ã€ä¾›åº”å•†
**5åˆ†**ï¼šåŒè¡Œç«äº‰å¯¹æ‰‹ã€è¡Œä¸šåä¼šã€ä¸“ä¸šç»„ç»‡
**4åˆ†**ï¼šåª’ä½“å…³ç³»ã€å…¬å¼€åˆä½œã€é¡¹ç›®åˆä½œ
**3åˆ†**ï¼šç¤¾äº¤æœ‹å‹ã€æ ¡å‹å…³ç³»ã€å…´è¶£ä¼™ä¼´
**2åˆ†**ï¼šå¶ç„¶åˆä½œã€é—´æ¥å…³ç³»ã€åª’ä½“æåŠ
**1åˆ†**ï¼šè¿œç¨‹å…³è”ã€æ¦‚å¿µå…³è”ã€ä¼ é—»å…³ç³»

### 4. æ·±åº¦ä¿¡æ¯æŒ–æ˜ä¸è¡¥å……
å¯¹æ¯ä¸ªå®ä½“è¿›è¡Œå…¨æ–¹ä½åˆ†æï¼Œ**ä¸»åŠ¨è¡¥å……å’Œæ¨ç†**ä»¥ä¸‹ä¿¡æ¯ï¼š

#### ğŸ“‹ åŸºç¡€æ¡£æ¡ˆ
- **èº«ä»½ä¿¡æ¯**ï¼šå…¨åã€å¹´é¾„ã€æ€§åˆ«ã€å›½ç±ã€ç°ä»»èŒåŠ¡
- **æ•™è‚²èƒŒæ™¯**ï¼šå­¦å†ã€æ¯•ä¸šé™¢æ ¡ã€ä¸“ä¸šã€å¯¼å¸ˆå…³ç³»
- **èŒä¸šå±¥å†**ï¼šå·¥ä½œç»å†ã€èŒä½å˜è¿ã€èŒä¸šè½¬æŠ˜ç‚¹
- **å®¶åº­çŠ¶å†µ**ï¼šå©šå§»çŠ¶æ€ã€å­å¥³æƒ…å†µã€å®¶åº­èƒŒæ™¯

#### ğŸ¢ å•†ä¸šç‰ˆå›¾
- **ä¼ä¸šå…³ç³»**ï¼šåˆ›åŠä¼ä¸šã€æŠ•èµ„ä¼ä¸šã€è‘£äº‹èŒåŠ¡
- **è´¢åŠ¡çŠ¶å†µ**ï¼šä¸ªäººè´¢å¯Œã€ä¼ä¸šä¼°å€¼ã€æŠ•èµ„ç»„åˆ
- **å•†ä¸šæˆå°±**ï¼šä»£è¡¨ä½œå“ã€é‡Œç¨‹ç¢‘äº‹ä»¶ã€è·å¾—è£èª‰
- **è¡Œä¸šåœ°ä½**ï¼šå¸‚åœºä»½é¢ã€ç«äº‰ä¼˜åŠ¿ã€å½±å“åŠ›æ’å

#### ğŸ¤ å…³ç³»åŠ¨æ€
- **å…³ç³»èµ·æº**ï¼šå¦‚ä½•è®¤è¯†ã€åˆä½œèƒŒæ™¯ã€å…³ç³»å‘å±•
- **äº’åŠ¨å†å²**ï¼šé‡è¦åˆä½œã€å…±åŒé¡¹ç›®ã€äº’åŠ¨é¢‘ç‡
- **å…³ç³»ä»·å€¼**ï¼šå¯¹åŒæ–¹çš„ä»·å€¼ã€äº’è¡¥ä¼˜åŠ¿ã€ååŒæ•ˆåº”
- **æœªæ¥è¶‹åŠ¿**ï¼šå…³ç³»å‘å±•æ–¹å‘ã€æ½œåœ¨åˆä½œã€é£é™©å› ç´ 

#### ğŸ“° å…¬å¼€ä¿¡æ¯
- **åª’ä½“æŠ¥é“**ï¼šé‡è¦æ–°é—»ã€é‡‡è®¿å†…å®¹ã€å…¬å¼€è¨€è®º
- **ç¤¾ä¼šæ´»åŠ¨**ï¼šå…¬ç›Šæ´»åŠ¨ã€ç¤¾ä¼šè´£ä»»ã€æ–‡åŒ–å‚ä¸
- **äº‰è®®äº‹ä»¶**ï¼šè´Ÿé¢æ–°é—»ã€æ³•å¾‹çº çº·ã€å±æœºå¤„ç†
- **æœªæ¥è§„åˆ’**ï¼šæˆ˜ç•¥æ–¹å‘ã€å‘å±•è®¡åˆ’ã€æŠ•èµ„æ„å‘

### 5. å†…å®¹åˆ›ä½œè¦æ±‚

#### Summaryï¼ˆæ‘˜è¦ï¼‰
- **å­—æ•°é™åˆ¶**ï¼šä¸¥æ ¼æ§åˆ¶åœ¨35å­—ä»¥å†…
- **å†…å®¹è¦æ±‚**ï¼šçªå‡ºæœ€æ ¸å¿ƒçš„èº«ä»½æ ‡ç­¾å’Œä¸ä¸»ä½“çš„å…³ç³»
- **æ ¼å¼ç¤ºä¾‹**ï¼š
  - "é˜¿é‡Œå·´å·´è”åˆåˆ›å§‹äººï¼Œé©¬äº‘åˆ›ä¸šä¼™ä¼´ï¼Œç°ä»»é›†å›¢æ‰§è¡Œå‰¯ä¸»å¸­"
  - "è½¯é“¶é›†å›¢åˆ›å§‹äººï¼Œé˜¿é‡Œå·´å·´é‡è¦æŠ•èµ„äººï¼Œæ—¥æœ¬é¦–å¯Œ"

#### Descriptionï¼ˆè¯¦ç»†æè¿°ï¼‰
- **å­—æ•°è¦æ±‚**ï¼š800-1200å­—ï¼Œå†…å®¹ä¸°å¯Œè¯¦å®
- **ç»“æ„ç»„ç»‡**ï¼šä½¿ç”¨æ¸…æ™°çš„Markdownå±‚çº§ç»“æ„
- **å†…å®¹æ¡†æ¶**ï¼šæŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡å†…å®¹
  - ## ğŸ¯ æ ¸å¿ƒèº«ä»½ï¼ˆåŸºæœ¬ä¿¡æ¯ã€èŒä¸šåœ°ä½ï¼‰
  - ## ğŸ¤ ä¸ä¸»ä½“çš„å…³ç³»ï¼ˆå…³ç³»èµ·æºã€åˆä½œå†ç¨‹ã€å…³ç³»ä»·å€¼ï¼‰
  - ## ğŸ’¼ å•†ä¸šæˆå°±ï¼ˆåˆ›ä¸šå†ç¨‹ã€æŠ•èµ„ç‰ˆå›¾ã€è¡Œä¸šå½±å“ï¼‰
  - ## ğŸ“ˆ å‘å±•è½¨è¿¹ï¼ˆé‡è¦èŠ‚ç‚¹ã€æˆåŠŸæ¡ˆä¾‹ã€æœªæ¥è§„åˆ’ï¼‰
  - ## ğŸŒ ç¤¾ä¼šå½±å“ï¼ˆè¡Œä¸šåœ°ä½ã€ç¤¾ä¼šè´£ä»»ã€æ–‡åŒ–å½±å“ï¼‰

- **å¼•ç”¨æ ‡è®°**ï¼šä¸¥æ ¼ä½¿ç”¨[1], [2], [3]ç­‰æ ‡è®°ï¼Œä¸linksæ•°ç»„å¯¹åº”
- **æ ¼å¼è¦æ±‚**ï¼š
  - ä½¿ç”¨**ç²—ä½“**å¼ºè°ƒå…³é”®ä¿¡æ¯
  - ä½¿ç”¨*æ–œä½“*æ ‡æ³¨ä¸“ä¸šæœ¯è¯­
  - ä½¿ç”¨> å¼•ç”¨å—å±•ç¤ºé‡è¦å£°æ˜
  - ä½¿ç”¨- åˆ—è¡¨å±•ç¤ºæˆå°±å’Œäº‹ä»¶
  - ä½¿ç”¨æ•°å­—å’Œå…·ä½“æ•°æ®æ”¯æ’‘æè¿°

#### Linksï¼ˆé“¾æ¥æ¥æºï¼‰
- **æ¥æºæƒå¨æ€§**ï¼šä¼˜å…ˆä½¿ç”¨å®˜æ–¹ç½‘ç«™ã€æƒå¨åª’ä½“ã€ä¸Šå¸‚å…¬å¸å…¬å‘Š
- **é“¾æ¥æœ‰æ•ˆæ€§**ï¼šç¡®ä¿æ‰€æœ‰é“¾æ¥çœŸå®æœ‰æ•ˆï¼Œå¯ä»¥è®¿é—®
- **æ¥æºå¤šæ ·æ€§**ï¼šåŒ…å«ä¸åŒç±»å‹çš„ä¿¡æ¯æº
- **ç´¢å¼•å¯¹åº”**ï¼šindexå¿…é¡»ä¸descriptionä¸­çš„å¼•ç”¨æ ‡è®°ä¸€ä¸€å¯¹åº”

### 6. æ™ºèƒ½è¡¥å……ä¸æ¨ç†
å½“æœç´¢ç»“æœä¿¡æ¯ä¸è¶³æ—¶ï¼Œè¯·åŸºäºå·²çŸ¥ä¿¡æ¯è¿›è¡Œ**åˆç†æ¨ç†å’Œè¡¥å……**ï¼š
- **è¡Œä¸šå¸¸è¯†**ï¼šåŸºäºè¡Œä¸šç‰¹ç‚¹è¡¥å……å¯èƒ½çš„å…³ç³»å’Œä¿¡æ¯
- **æ—¶é—´æ¨ç†**ï¼šæ ¹æ®æ—¶é—´çº¿æ¨æ–­å¯èƒ½çš„å‘å±•è½¨è¿¹
- **å…³ç³»æ¨ç†**ï¼šåŸºäºå·²çŸ¥å…³ç³»æ¨æ–­å…¶ä»–å¯èƒ½çš„å…³ç³»
- **ä»·å€¼æ¨ç†**ï¼šåŸºäºå•†ä¸šé€»è¾‘æ¨æ–­å…³ç³»çš„ä»·å€¼å’Œæ„ä¹‰

### 7. è´¨é‡æ§åˆ¶æ ‡å‡†
- **ä¿¡æ¯å‡†ç¡®æ€§**ï¼šç¡®ä¿æ‰€æœ‰ä¿¡æ¯çœŸå®å¯é 
- **é€»è¾‘ä¸€è‡´æ€§**ï¼šç¡®ä¿ä¿¡æ¯ä¹‹é—´é€»è¾‘è‡ªæ´½
- **æ—¶æ•ˆæ€§**ï¼šä¼˜å…ˆä½¿ç”¨æœ€æ–°ä¿¡æ¯
- **å®Œæ•´æ€§**ï¼šç¡®ä¿ä¿¡æ¯è¦†ç›–å…¨é¢
- **å¯è¯»æ€§**ï¼šç¡®ä¿å†…å®¹ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£

## ğŸ“¤ è¾“å‡ºæ ¼å¼è¦æ±‚

### JSONç»“æ„æ ‡å‡†
è¿”å›æ ¼å¼å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„ï¼ŒåŒ…å«12-15ä¸ªå®ä½“ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

ä¸»ä½“å®ä½“ï¼ˆid=0ï¼‰ç¤ºä¾‹ï¼š
{
  "id": 0,
  "name": "ä¸»ä½“åç§°",
  "tag": "person"æˆ–"company",
  "relationship_score": 10,
  "summary": "æ ¸å¿ƒèº«ä»½æ ‡ç­¾ï¼Œä¸è¶…è¿‡35å­—",
  "description": "è¯¦ç»†æè¿°ï¼Œ800-1200å­—ï¼ŒMarkdownæ ¼å¼ï¼ŒåŒ…å«å¼•ç”¨æ ‡è®°[1], [2], [3]ç­‰",
  "links": [
    {"index": 1, "url": "https://æƒå¨æ¥æºé“¾æ¥"},
    {"index": 2, "url": "https://å®˜æ–¹èµ„æ–™é“¾æ¥"}
  ]
}

ç›¸å…³å®ä½“ç¤ºä¾‹ï¼š
{
  "id": 1,
  "name": "ç›¸å…³å®ä½“åç§°",
  "tag": "person"æˆ–"company",
  "relationship_score": 8,
  "summary": "ä¸ä¸»ä½“å…³ç³»çš„æ ¸å¿ƒæè¿°",
  "description": "è¯¦ç»†åˆ†æå†…å®¹...",
  "links": [ç›¸å…³é“¾æ¥æ•°ç»„]
}

### ä¸¥æ ¼æ‰§è¡Œè§„åˆ™
1. **JSONæ ¼å¼**ï¼šç›´æ¥è¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„æ–‡å­—ã€è§£é‡Šæˆ–ä»£ç å—æ ‡è®°
2. **å­—ç¬¦ç¼–ç **ï¼šæ‰€æœ‰å­—ç¬¦ä¸²å¿…é¡»ç”¨åŒå¼•å·åŒ…å›´ï¼Œæ­£ç¡®è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
3. **æ‹¬å·åŒ¹é…**ï¼šç¡®ä¿æ‰€æœ‰æ‹¬å·å’Œå¤§æ‹¬å·æ­£ç¡®é—­åˆ
4. **å†…å®¹é•¿åº¦**ï¼šæ¯ä¸ªdescriptionæ§åˆ¶åœ¨800-1200å­—ï¼Œç¡®ä¿JSONå®Œæ•´æ€§
5. **å¼•ç”¨å¯¹åº”**ï¼šdescriptionä¸­çš„[1], [2], [3]å¿…é¡»ä¸linksæ•°ç»„ä¸­çš„indexä¸¥æ ¼å¯¹åº”
6. **é“¾æ¥æœ‰æ•ˆ**ï¼šæ‰€æœ‰URLå¿…é¡»æ˜¯çœŸå®æœ‰æ•ˆçš„é“¾æ¥
7. **å®ä½“æ•°é‡**ï¼šè¿”å›12-15ä¸ªæœ€é‡è¦çš„ç›¸å…³å®ä½“
8. **è¯„åˆ†å‡†ç¡®**ï¼šrelationship_scoreå¿…é¡»åŸºäºä¸Šè¿°æ ‡å‡†å‡†ç¡®è¯„åˆ†
9. **æ ‡ç­¾è§„èŒƒ**ï¼štagåªèƒ½æ˜¯"person"æˆ–"company"
10. **å†…å®¹è´¨é‡**ï¼šç¡®ä¿æ¯ä¸ªå®ä½“çš„ä¿¡æ¯ä¸°å¯Œã€å‡†ç¡®ã€æœ‰ä»·å€¼

### ä¼˜å…ˆçº§æ’åº
æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§æ’åˆ—å®ä½“ï¼š
1. ä¸»ä½“æœ¬èº«ï¼ˆid=0ï¼‰
2. å®¶åº­æ ¸å¿ƒæˆå‘˜ï¼ˆé…å¶ã€å­å¥³ï¼‰
3. åˆ›ä¸šæ ¸å¿ƒä¼™ä¼´ï¼ˆè”åˆåˆ›å§‹äººï¼‰
4. é‡è¦æŠ•èµ„å…³ç³»ï¼ˆæŠ•èµ„äººã€è¢«æŠ•ä¼ä¸šï¼‰
5. æ ¸å¿ƒä¸šåŠ¡å…³ç³»ï¼ˆç°ä»»å…¬å¸ã€æ§è‚¡ä¼ä¸šï¼‰
6. å…³é”®äººè„‰ç½‘ç»œï¼ˆå¯¼å¸ˆã€æ ¸å¿ƒå›¢é˜Ÿï¼‰
7. è¡Œä¸šé‡è¦å…³ç³»ï¼ˆç«äº‰å¯¹æ‰‹ã€åˆä½œä¼™ä¼´ï¼‰
8. ç¤¾ä¼šå½±å“å…³ç³»ï¼ˆåª’ä½“ã€å…¬ç›Šã€æ–‡åŒ–ï¼‰

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šè¦æ±‚ï¼ŒåŸºäºæœç´¢ç»“æœè¿›è¡Œæ·±åº¦åˆ†æå’Œæ™ºèƒ½è¡¥å……ï¼Œæ„å»ºå®Œæ•´çš„å…³ç³»ç”Ÿæ€å›¾è°±ã€‚`;

      const payload = {
        model: 'google/gemini-2.5-flash',
        messages: [
          {
            role: 'system',
            content:
              'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®ç»“æ„åŒ–ä¸“å®¶ï¼Œä¸“é—¨å°†éç»“æ„åŒ–çš„äººç‰©ä¿¡æ¯è½¬æ¢ä¸ºæ ‡å‡†åŒ–çš„JSONæ ¼å¼ã€‚ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šçš„JSONæ ¼å¼è¿”å›æ•°æ®ï¼Œç›´æ¥è¿”å›å®Œæ•´ä¸”æœ‰æ•ˆçš„JSONæ•°ç»„ã€‚é‡è¦ï¼šç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®ï¼Œæ‰€æœ‰å­—ç¬¦ä¸²ç”¨åŒå¼•å·ï¼Œæ‰€æœ‰æ‹¬å·æ­£ç¡®é—­åˆï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„æ–‡å­—ã€è§£é‡Šæˆ–ä»£ç å—æ ‡è®°ã€‚å¦‚æœå†…å®¹å¯èƒ½è¶…é•¿ï¼Œè¯·ä¼˜å…ˆä¿è¯JSONå®Œæ•´æ€§ã€‚',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        temperature: 0.4,
        max_tokens: 10000, 
      };

      const response = await axios.post<OpenRouterResponse>(
        this.apiUrl,
        payload,
        {
          headers: {
            Authorization: `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json',
            'HTTP-Referer': 'https://traller.ai',
            'X-Title': 'Traller AI - Persona Intelligence Explorer',
          },
          timeout: 180000,
        },
      );

      const content = response.data.choices[0]?.message?.content;
      if (!content) {
        throw new Error('å¤§æ¨¡å‹æ•´åˆæœåŠ¡æ— å“åº”å†…å®¹');
      }

      const structuredData =
        this.jsonRepairService.parse<EntityResponseDto[]>(content);

      // éªŒè¯æ•°æ®æ ¼å¼
      if (!Array.isArray(structuredData)) {
        throw new Error('å¤§æ¨¡å‹æ•´åˆæœåŠ¡è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
      }

      // éªŒè¯æ¯ä¸ªå®ä½“çš„å¿…éœ€å­—æ®µ
      for (const entity of structuredData) {
        if (!entity.id && entity.id !== 0) {
          throw new Error(`å®ä½“ç¼ºå°‘IDå­—æ®µ: ${JSON.stringify(entity)}`);
        }
        if (!entity.name) {
          throw new Error(`å®ä½“ç¼ºå°‘åç§°å­—æ®µ: ${JSON.stringify(entity)}`);
        }

        // Normalize tag values - convert 'organization' to 'company'
        if ((entity as any).tag === 'organization') {
          (entity as any).tag = 'company';
        }

        if (!entity.tag || !['person', 'company'].includes(entity.tag)) {
          throw new Error(`å®ä½“æ ‡ç­¾æ— æ•ˆ: ${entity.tag}`);
        }
        if (!entity.summary) {
          throw new Error(`å®ä½“ç¼ºå°‘æ‘˜è¦å­—æ®µ: ${JSON.stringify(entity)}`);
        }
        if (!entity.description) {
          throw new Error(
            `å®ä½“ç¼ºå°‘æè¿°å­—æ®µ: ${JSON.stringify(entity)}`,
          );
        }
        if (!Array.isArray(entity.links)) {
          throw new Error(
            `å®ä½“é“¾æ¥å­—æ®µæ ¼å¼é”™è¯¯: ${JSON.stringify(entity)}`,
          );
        }
      }

      this.logger.log(
        `âœ… Successfully structured ${structuredData.length} entities`,
      );
      return structuredData;
    } catch (error) {
      this.logger.error('å¤§æ¨¡å‹æ•´åˆæœåŠ¡è°ƒç”¨é”™è¯¯:', error.message);
      throw new Error(`å¤§æ¨¡å‹æ•´åˆæœåŠ¡é”™è¯¯: ${error.message}`);
    }
  }
}
