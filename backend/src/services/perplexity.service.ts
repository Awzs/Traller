import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import axios, { AxiosResponse } from 'axios';

interface OpenRouterResponse {
  id: string;
  object: string;
  created: number;
  model: string;
  choices: {
    index: number;
    finish_reason: string;
    message: {
      role: string;
      content: string;
    };
  }[];
  usage: {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
  };
}

@Injectable()
export class PerplexityService {
  private readonly logger = new Logger(PerplexityService.name);
  private readonly apiKey: string;
  private readonly apiUrl: string;

  constructor(private configService: ConfigService) {
    // ä½¿ç”¨ OpenRouter API å¯†é’¥å’Œ URL
    this.apiKey = this.configService.get<string>('KIMI_API_KEY') || '';
    this.apiUrl = this.configService.get<string>('KIMI_API_URL') || 'https://openrouter.ai/api/v1/chat/completions';

    if (!this.apiKey) {
      this.logger.warn(
        'âš ï¸  æœªé…ç½® OpenRouter API å¯†é’¥ï¼è¯·åœ¨.envæ–‡ä»¶ä¸­é…ç½®KIMI_API_KEY',
      );
    }
  }

  async searchInformation(query: string): Promise<string> {
    const maxRetries = 3;
    let lastError: Error | null = null;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        this.logger.log(
          `Perplexity API attempt ${attempt}/${maxRetries} for query: ${query}`,
        );
        const prompt = `ä½œä¸ºä¸“ä¸šçš„ä¿¡æ¯ç ”ç©¶åˆ†æå¸ˆï¼Œè¯·å¯¹"${query}"è¿›è¡Œå…¨æ–¹ä½æ·±åº¦è°ƒç ”ï¼Œæ„å»ºå®Œæ•´çš„å…³ç³»ç”Ÿæ€å›¾è°±ã€‚è¯·æŒ‰ä»¥ä¸‹æ¡†æ¶è¿›è¡Œç³»ç»Ÿæ€§åˆ†æï¼š

## ğŸ¯ æ ¸å¿ƒèº«ä»½æ¡£æ¡ˆ
1. **åŸºç¡€ä¿¡æ¯**ï¼šå…¨åã€åˆ«åã€å¹´é¾„ã€æ€§åˆ«ã€å›½ç±ã€ç±è´¯ã€ç°å±…åœ°
2. **èŒä¸šèº«ä»½**ï¼šç°ä»»èŒåŠ¡ã€å…¬å¸èŒä½ã€è¡Œä¸šè§’è‰²ã€ç¤¾ä¼šèº«ä»½
3. **è”ç³»ä¿¡æ¯**ï¼šå®˜æ–¹ç½‘ç«™ã€ç¤¾äº¤åª’ä½“ã€å…¬å¼€é‚®ç®±ã€åŠå…¬åœ°å€
4. **æ•™è‚²å±¥å†**ï¼šå­¦å†èƒŒæ™¯ã€æ¯•ä¸šé™¢æ ¡ã€ä¸“ä¸šé¢†åŸŸã€å¯¼å¸ˆå…³ç³»ã€åŒçª—å¥½å‹
5. **èŒä¸šè½¨è¿¹**ï¼šå®Œæ•´å·¥ä½œç»å†ã€èŒä½å˜è¿ã€è·³æ§½åŸå› ã€èŒä¸šè½¬æŠ˜ç‚¹

## ğŸŒ å…³ç³»ç½‘ç»œç”Ÿæ€
### å®¶åº­åœˆå±‚
6. **ç›´ç³»äº²å±**ï¼šé…å¶ã€å­å¥³ã€çˆ¶æ¯çš„è¯¦ç»†ä¿¡æ¯å’ŒèƒŒæ™¯
7. **æ‰©å±•å®¶åº­**ï¼šå…„å¼Ÿå§å¦¹ã€å²³çˆ¶æ¯ã€äº²æˆšä¸­çš„é‡è¦äººç‰©
8. **å®¶æ—ä¼ä¸š**ï¼šå®¶æ—ç”Ÿæ„ã€å®¶åº­æŠ•èµ„ã€è´¢äº§åˆ†é…

### å•†ä¸šåœˆå±‚
9. **åˆ›ä¸šä¼™ä¼´**ï¼šè”åˆåˆ›å§‹äººã€æ—©æœŸåˆä¼™äººã€è‚¡æƒå…³ç³»
10. **æŠ•èµ„å…³ç³»**ï¼šå¤©ä½¿æŠ•èµ„äººã€VCæœºæ„ã€PEåŸºé‡‘ã€è¢«æŠ•ä¼ä¸š
11. **è‘£äº‹ç½‘ç»œ**ï¼šæ‹…ä»»è‘£äº‹çš„å…¬å¸ã€å…±åŒè‘£äº‹ã€è‘£äº‹ä¼šå…³ç³»
12. **å•†ä¸šè”ç›Ÿ**ï¼šæˆ˜ç•¥åˆä½œä¼™ä¼´ã€ä¾›åº”å•†ã€å®¢æˆ·ã€ç«äº‰å¯¹æ‰‹

### èŒåœºåœˆå±‚
13. **æ ¸å¿ƒå›¢é˜Ÿ**ï¼šç›´æ¥ä¸‹å±ã€æ ¸å¿ƒå‘˜å·¥ã€å·¦å³æ‰‹
14. **åŒçº§åŒäº‹**ï¼šå¹³çº§åˆä½œä¼™ä¼´ã€è·¨éƒ¨é—¨åä½œè€…
15. **ä¸Šçº§å…³ç³»**ï¼šæ±‡æŠ¥å¯¹è±¡ã€mentorã€èŒä¸šå¼•è·¯äºº
16. **è¡Œä¸šäººè„‰**ï¼šåŒè¡Œç²¾è‹±ã€è¡Œä¸šåä¼šã€ä¸“ä¸šç»„ç»‡

### ç¤¾äº¤åœˆå±‚
17. **ç§äººå‹è°Š**ï¼šå¯†å‹ã€å‘å°ã€å…´è¶£ä¼™ä¼´ã€ç¤¾äº¤åœˆ
18. **å¯¼å¸ˆå…³ç³»**ï¼šäººç”Ÿå¯¼å¸ˆã€èŒä¸šå¯¼å¸ˆã€ç²¾ç¥å¯¼å¸ˆ
19. **å­¦ç”Ÿå…³ç³»**ï¼šé—¨ç”Ÿã€å¾’å¼Ÿã€ä¼ æ‰¿å…³ç³»
20. **å…¬ç›Šç½‘ç»œ**ï¼šæ…ˆå–„åˆä½œã€å…¬ç›Šç»„ç»‡ã€ç¤¾ä¼šè´£ä»»

## ğŸ“ˆ æˆé•¿å‘å±•è½¨è¿¹
21. **åˆ›ä¸šå†ç¨‹**ï¼šåˆ›ä¸šåŠ¨æœºã€å…³é”®èŠ‚ç‚¹ã€èèµ„å†ç¨‹ã€å‘å±•é˜¶æ®µ
22. **é‡å¤§å†³ç­–**ï¼šæˆ˜ç•¥è½¬æŠ˜ã€é‡è¦é€‰æ‹©ã€å†³ç­–èƒŒæ™¯ã€å½±å“ç»“æœ
23. **æˆåŠŸæ¡ˆä¾‹**ï¼šä»£è¡¨ä½œå“ã€é‡Œç¨‹ç¢‘äº‹ä»¶ã€è·å¾—æˆå°±ã€ç¤¾ä¼šè®¤å¯
24. **æŒ«æŠ˜ç»å†**ï¼šå¤±è´¥æ¡ˆä¾‹ã€å±æœºå¤„ç†ã€å¤ç›˜åæ€ã€ä¸œå±±å†èµ·
25. **å­¦ä¹ æˆé•¿**ï¼šçŸ¥è¯†æ›´æ–°ã€æŠ€èƒ½æå‡ã€æ€ç»´è¿›åŒ–ã€æ ¼å±€æ‰©å±•

## ğŸ” æ·±åº¦èƒŒæ™¯è°ƒç ”
26. **åª’ä½“å½¢è±¡**ï¼šå…¬å¼€æŠ¥é“ã€é‡‡è®¿å†…å®¹ã€æ¼”è®²è§‚ç‚¹ã€åª’ä½“è¯„ä»·
27. **äº‰è®®äº‹ä»¶**ï¼šè´Ÿé¢æ–°é—»ã€æ³•å¾‹çº çº·ã€å•†ä¸šäº‰è®®ã€å…¬å…³å±æœº
28. **ä»·å€¼è§‚å¿µ**ï¼šäººç”Ÿå“²å­¦ã€å•†ä¸šç†å¿µã€ç¤¾ä¼šè§‚ç‚¹ã€æ–‡åŒ–ç«‹åœº
29. **ç”Ÿæ´»æ–¹å¼**ï¼šå…´è¶£çˆ±å¥½ã€ç”Ÿæ´»ä¹ æƒ¯ã€æ¶ˆè´¹åå¥½ã€ä¼‘é—²æ–¹å¼
30. **å½±å“åŠ›è¯„ä¼°**ï¼šè¡Œä¸šåœ°ä½ã€ç¤¾ä¼šå½±å“ã€è¯è¯­æƒã€é¢†å¯¼åŠ›

## ğŸ’° è´¢å¯Œä¸èµ„äº§
31. **è´¢å¯ŒçŠ¶å†µ**ï¼šä¸ªäººå‡€èµ„äº§ã€è´¢å¯Œæ’åã€æ”¶å…¥æ¥æºã€èµ„äº§é…ç½®
32. **æŠ•èµ„ç»„åˆ**ï¼šè‚¡æƒæŠ•èµ„ã€æˆ¿äº§æŠ•èµ„ã€é‡‘èæŠ•èµ„ã€æ”¶è—æŠ•èµ„
33. **å…¬å¸ä»·å€¼**ï¼šä¼ä¸šä¼°å€¼ã€å¸‚å€¼å˜åŒ–ã€è‚¡æƒç»“æ„ã€åˆ†çº¢æƒ…å†µ

## ğŸš€ åˆ›æ–°ä¸æœªæ¥
34. **åˆ›æ–°æˆæœ**ï¼šä¸“åˆ©æŠ€æœ¯ã€äº§å“åˆ›æ–°ã€å•†ä¸šæ¨¡å¼ã€ç®¡ç†åˆ›æ–°
35. **é¢†å¯¼é£æ ¼**ï¼šç®¡ç†å“²å­¦ã€å›¢é˜Ÿæ–‡åŒ–ã€æ¿€åŠ±æ–¹å¼ã€å†³ç­–é£æ ¼
36. **æˆ˜ç•¥è§„åˆ’**ï¼šæœªæ¥æ„¿æ™¯ã€å‘å±•æˆ˜ç•¥ã€æ‰©å¼ è®¡åˆ’ã€è½¬å‹æ–¹å‘
37. **è¡Œä¸šè¶‹åŠ¿**ï¼šå¯¹è¡Œä¸šçš„åˆ¤æ–­ã€é¢„æµ‹ã€å¸ƒå±€ã€åº”å¯¹ç­–ç•¥

## ğŸ“Š æ•°æ®è¦æ±‚
- **æ—¶é—´ç»´åº¦**ï¼šæä¾›å…·ä½“æ—¶é—´ã€å‘å±•æ—¶é—´çº¿ã€é‡è¦æ—¶é—´èŠ‚ç‚¹
- **æ•°æ®æ”¯æ’‘**ï¼šå…·ä½“æ•°å­—ã€ç»Ÿè®¡æ•°æ®ã€è´¢åŠ¡æ•°æ®ã€ä¸šç»©æ•°æ®
- **æ¥æºæ ‡æ³¨**ï¼šæ¯æ¡ä¿¡æ¯éƒ½è¦æ ‡æ³¨å…·ä½“æ¥æºå’Œé“¾æ¥
- **å…³ç³»é‡åŒ–**ï¼šç”¨1-10åˆ†è¯„ä¼°å…³ç³»ç´§å¯†ç¨‹åº¦ï¼Œå¹¶è¯´æ˜è¯„åˆ†ä¾æ®
- **å½±å“è¯„ä¼°**ï¼šåˆ†ææ¯ä¸ªå…³ç³»å¯¹ä¸»ä½“çš„å…·ä½“å½±å“å’Œä»·å€¼

è¯·ç¡®ä¿ä¿¡æ¯çš„å‡†ç¡®æ€§ã€æ—¶æ•ˆæ€§å’Œæƒå¨æ€§ï¼Œä¼˜å…ˆä½¿ç”¨å®˜æ–¹èµ„æ–™ã€æƒå¨åª’ä½“ã€ä¸Šå¸‚å…¬å¸å…¬å‘Šç­‰å¯é æ¥æºã€‚å¯¹äºæ¯ä¸ªç›¸å…³äººç‰©å’Œæœºæ„ï¼Œè¯·è¯¦ç»†åˆ†æå…¶ä¸æŸ¥è¯¢å¯¹è±¡çš„å…³ç³»å½¢æˆè¿‡ç¨‹ã€äº’åŠ¨å†å²ã€åˆä½œæˆæœå’Œæœªæ¥å¯èƒ½çš„å‘å±•æ–¹å‘ã€‚`;

        const response: AxiosResponse<OpenRouterResponse> = await axios.post(
          this.apiUrl,
          {
            model: 'perplexity/sonar-pro',
            messages: [
              {
                role: 'user',
                content: prompt,
              },
            ],
            max_tokens: 8000, // å¤§å¹…æé«˜tokenæ•°ä»¥æ”¯æŒæ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡
            temperature: 0.3, // é™ä½æ¸©åº¦ä»¥è·å¾—æ›´ç¨³å®šçš„ç»“æœ
          },
          {
            headers: {
              Authorization: `Bearer ${this.apiKey}`,
              'Content-Type': 'application/json',
              'HTTP-Referer': 'https://traller.ai',
              'X-Title': 'Traller AI - Persona Intelligence Explorer',
            },
            timeout: 180000, // å¢åŠ åˆ°3åˆ†é’Ÿè¶…æ—¶ä»¥å¤„ç†æ›´é•¿çš„ä¸Šä¸‹æ–‡
          },
        );

        if (response.data.choices && response.data.choices.length > 0) {
          this.logger.log(`âœ… è”ç½‘æœç´¢æœåŠ¡ successful on attempt ${attempt}`);
          return response.data.choices[0].message.content;
        }

        throw new Error('No response from è”ç½‘æœç´¢æœåŠ¡');
      } catch (error) {
        lastError = error as Error;
        this.logger.warn(
          `âŒ è”ç½‘æœç´¢æœåŠ¡ attempt ${attempt} failed:`,
          (error as Error).message,
        );

        if (attempt === maxRetries) {
          this.logger.error(
            'All è”ç½‘æœç´¢æœåŠ¡ attempts failed:',
            (error as Error).message,
          );
          break;
        }

        // é‡è¯•å‰ç­‰å¾…
        const waitTime = attempt * 2000; // 2ç§’, 4ç§’, 6ç§’
        this.logger.log(`â³ Waiting ${waitTime}ms before retry...`);
        await new Promise((resolve) => setTimeout(resolve, waitTime));
      }
    }

    // Throw an error with the last encountered error message if all attempts fail
    throw new Error(
      `è”ç½‘æœç´¢æœåŠ¡é”™è¯¯: ${lastError?.message || 'Unknown error'}`,
    );
  }
}
